<!DOCTYPE html>
<!--
Copyright (c) 2003-2020, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
-->
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Full Page Editing &mdash; CKEditor</title>


    <!---- Insert this before scripts import; then restor back later -->
    <script>if (typeof module === 'object') { window.module = module; module = undefined; }</script>

    <!-------------- ckeditor only--------------------->
    <script src="https://wdingbox.github.io/ham12/jq/jquery-2_1_3.min.js"></script>

    <script ___src="https://cdn.ckeditor.com/4.15.0/standard/ckeditor.js"></script>
    <script _src="https://wdingbox.github.io/ham12/assets/ckeditor/ckeditor.js"></script>
    <script src="http://localhost:7878/assets/ckeditor/ckeditor.js" note="selfseversite"></script>


    <script src="https://wdingbox.github.io/ham12/assets/ckeditor/samples/old/sample.js"></script>
    <link href="https://wdingbox.github.io/ham12/assets/ckeditor/samples/old/sample.css" rel="stylesheet">
    <meta name="ckeditor-sample-required-plugins" content="sourcearea">
    <meta name="ckeditor-sample-name" content="Full page support">
    <meta name="ckeditor-sample-group" content="Plugins">
    <meta name="ckeditor-sample-description"
        content="CKEditor inserted with a JavaScript call and used to edit the whole page from &lt;html&gt; to &lt;/html&gt;.">
    <meta name="description"
        content="Try the latest sample of CKEditor 4 and learn more about customizing your WYSIWYG editor with endless possibilities.">
    <!-------------------------------------------->
    <script ____src="./doc_files/jquery-2_1_3.min.js"></script>

    <!----- Insert this line after script imports -->
    <script>if (window.module) module = window.module;</script>

</head>

<body>

    <h1 class="samples">
        <a href="../../samples/old/index.html">CKEditor</a> &raquo; <a id="info">Full Page Editing</a>
    </h1>

    <form action="http://localhost:7878/save" method="post">
        <label for="editor1">
            CKEditor output the entire page including content outside of
            <code>&lt;body&gt;</code> element, so content like meta and title can be changed:
        </label>
        <textarea cols="80" id="editor1" name="editor1" rows="10">
			&lt;h1&gt;&lt;img align=&quot;right&quot; alt=&quot;Saturn V carrying Apollo 11&quot; src=&quot;../../_ckeditor/_app/old/assets/sample.jpg&quot;/&gt; Apollo 11&lt;/h1&gt; &lt;p&gt;&lt;b&gt;Apollo 11&lt;/b&gt; was the spaceflight that landed the first humans, Americans &lt;a href=&quot;http://en.wikipedia.org/wiki/Neil_Armstrong&quot; title=&quot;Neil Armstrong&quot;&gt;Neil Armstrong&lt;/a&gt; and &lt;a href=&quot;http://en.wikipedia.org/wiki/Buzz_Aldrin&quot; title=&quot;Buzz Aldrin&quot;&gt;Buzz Aldrin&lt;/a&gt;, on the Moon on July 20, 1969, at 20:18 UTC. Armstrong became the first to step onto the lunar surface 6 hours later on July 21 at 02:56 UTC.&lt;/p&gt; &lt;p&gt;
		</textarea>
    </form>
    <p>
        <select id="log" size="10"></select>
    </p>

    <div id="footer">
        <hr>
        <p>
            CKEditor - The text editor for the Internet - <a class="samples"
                href="https://ckeditor.com/">https://ckeditor.com</a>
        </p>
        <p id="copy">
            Copyright &copy; 2003-2020, <a class="samples" href="https://cksource.com/">CKSource</a> - Frederico
            Knabben. All rights reserved.
        </p>

    </div>







    <script>
        function init_CKEditor() {
            var ckEditor = CKEDITOR.replace('editor1', {
                fullPage: true,
                allowedContent: true,
                extraPlugins: 'wysiwygarea',
                width: '100%',

                on: {
                    focus: function () { },
                    blur: function () { },

                    // Check for availability of corresponding plugins.
                    pluginsLoaded: function (evt) {
                        var doc = CKEDITOR.document, ed = evt.editor;
                        if (!ed.getCommand('bold'))
                            doc.getById('exec-bold').hide();
                        if (!ed.getCommand('link'))
                            doc.getById('exec-link').hide();
                    }
                }

            });



            // wait until the editor has done initializing
            ckEditor.on("instanceReady", function () {

                // overwrite the default save function
                ckEditor.addCommand("save", {
                    modes: { wysiwyg: 1, source: 1 },
                    exec: function () {
                        // get the editor content
                        var theData = ckEditor.getData();
                        if (false === ckEditor.checkDirty()) {
                            console.log("checkDirty : false")
                            //$("#info").html("<font color='green'>no change</color>");
                            msg.dlt(theData.length).pop("no change.");
                            return
                        }
                        msg.put(`to save len:${theData.length}`).dlt(theData.length);
                        //alert(theData);
                        $.post("http://localhost:7878/save",
                            {
                                "pathname": get_custom_pathname().pathname,
                                "htm": theData
                            },
                            function (result) {
                                ckEditor.resetDirty()
                                if(theData.length !== result.len){
                                    alert(`fatal err save. data loss:${theData.length}-${result.len}=${theData.length-result.len}`)
                                }
                                console.log("ret:", result.len);
                                msg.pop(`OK Saved ${result.len}`, 'green');
                            }).fail(function (er) {
                                msg.pop(`*** saved failed:${er}`, "red")
                            }).done(function (ret) {
                                console.log("done:", ret)
                            });
                    }
                });
            });
        }

        function MSG() {
            this.m_pre_len = 0
            this.m_log = ""
        }
        MSG.prototype.dlt = function (size) {
            this.m_dlt = size - this.m_pre_len
            this.m_pre_len = size
            return this
        }
        MSG.prototype.put = function (s) {
            this.m_log += s + "; ";
            return this
        }
        MSG.prototype.pop = function (s, clr) {
            if (!clr) clr = "black"
            this.m_log += s + "; dlt=" + this.m_dlt
            $("#log").prepend(`<option>${this.m_log}</option>`)
            $("#info").html(this.m_log).css("color", clr)
            this.m_log = ""
        }
        var msg = new MSG()

        function get_custom_pathname() {
            var pathname = window.location.pathname.replace(/___fullpage_ckeditor\.htm$/, "")
            var ary = pathname.split("/")
            var name = ary[ary.length - 1]
            return { name: name, pathname: pathname }
        }
        function load_page_by_parse_filename() {
            console.log(window.location)
            var fname = get_custom_pathname().name
            console.log(fname)
            $.get(fname, function (data) {
                //alert(data);
                msg.put("initial load file").dlt(data.length).pop("", "")
                CKEDITOR.instances.editor1.setData(data)
            });
        }
    </script>
</body>

</html>

<script>
    $(function () {
        init_CKEditor()
        load_page_by_parse_filename()
    })
</script>